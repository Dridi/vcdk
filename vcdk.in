#!/bin/sh
#
# Copyright (C) 2017  Dridi Boukelmoune
# All rights reserved.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

set -e
set -u

DEFAULT_BUILD=autotools
DEFAULT_PLUGINS='@vcdkdir@'
DEFAULT_SETUP='@libexecdir@'
NAME_REGEX='^[[:alnum:]_-]*$'

OPTIONS_USAGE="\
Usage: $0 [--name <name>] [--vmod <vmod> [--vsc <vsc>]] [--vut <vut>]
       $0 --help

At least one VMOD or one VUT must be specified, a VSC can only be used
in a VMOD. Options can only appear once in the command line, and options
that take an argument support both \`--opt value\` and \`--opt=value\`
notations.

Options:
"

OPTIONS_SPEC="\
--help			display this message and exit
--build=<plugin>	the build plugin (default: $DEFAULT_BUILD)
--name=<name>		the project name (pattern: $NAME_REGEX)
--output=<dir>		default: the project name
--plugins=<dir>		default: $DEFAULT_PLUGINS
--verbose		display status information of the execution
--vmod=<vmod>		a comma-separated list of vmods to build
--vsc=<vsc>		a comma-separated list of counters to build
--vut=<vut>		a comma-separated list of utilities to build
"

help=false
build=
name=
output=
plugins=
verbose=false
vmod=
vsc=
vut=

. "${VCDK_SETUP:-$DEFAULT_SETUP}/vcdk-setup.sh"

options_init "$@"
shift $opt_ind

if $help
then
	usage
	exit
fi

if [ -z "$name" ]
then
	usage_error 'missing project name'
fi

if ! echo "$name" | grep -Eq "$NAME_REGEX"
then
	usage_error "invalid project name: $name"
fi

if [ -z "$vmod" ] && [ -z "$vut" ]
then
	usage_error 'no VMOD and no VUT to build'
fi

if [ -z "$vmod" ] && [ -n "$vsc" ]
then
	usage_error 'a VSC can only be used by a VMOD'
fi

output=${output:-$name}
rmdir "$output" 2>/dev/null || :
mkdir "$output"
cd "$output"

build=${build:-$DEFAULT_BUILD}
plugins=${plugins:-$DEFAULT_PLUGINS}

export VCDK_NAME=$name
export VCDK_NAME=$name
export VCDK_VMOD=$vmod
export VCDK_VUT=$vut
export VCDK_VSC=$vsc
export VCDK_VERBOSE=$verbose

exec "$plugins/$build"
